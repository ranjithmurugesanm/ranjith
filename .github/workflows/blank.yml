name: Deploy

on:
  push:
    branches: [ dev ]

jobs:
  Deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v2 
      - name: Build & Deploy
        env:
            PRIVATE_KEY: ${{-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEArBKNGO78OFodyeUFzeqL5177oz7QsIvz7PIahU6DZ7SBFp9n
FrKUZGRq0AwAuxBz/WXvrpeDtPJdRrudBlTP4HY5IQyQl54lhjrbGajMTr71nKgT
bDa0GfFC+SgE8dPenwcmEDLYqm7IqyAkzusH1u7g7qfhz2Pm8Th0XvPXdJqpJGKe
Vny35tC2yXuL0tQ4PNIRWAae4Tab23MfvnM4vYVu3/BQWx+fkV79B7kh//6/ifbF
wpKiYaUsg2Tu84ecw+OTJG4RugpaeEhIZ4Im2s7VTCRyfCVGV8f7PhqD45u+Zfe1
ZlR4cs95wLLYW767dN9twmif9JozhNtzMpxWaQIDAQABAoIBAQCAATjnkHkerqM0
WuQLf+zdjMIjeYojm6k03hGuk26biiLxolk9AFH1sOHorNUqU54Fpnw75Ei9JgMP
qGeymwsdTrVHCaLSt3nwtf3hw7lg5xutkzcHrFYkal7JHOU4xMT6hoXhTQHzH4C2
FK5tI1hsor2/rDIGZqoZTkb7j+f6vAlLu+qiY1mC1XalHsPqtJM6vCYyCNJ6+k+4
fiP4zX4ITJgkW20PvLw0j5Ez0v51qA9ceyhYSHBAYxteFd3KqKbA1YbBHJ1z7tX2
5af4QvshPTXwc0I/i5WV67vA0CUi6Ow+OaJ3y7cKMzXmCzf+AS6WuUWDD4UxWmpJ
Gy+cL4KBAoGBAP0qt3VUps5pigHxwQGDJAH/W9eeGtTRfYn+LbsLvfICIx7Csnm/
Ie2qlHV7P7JQgQVvyfAb0dGI69r+tUvOg9/QRKlZIpRsVt/TPlMWkHWKmS+uZhRw
ICx8fUJaTJH8SKTv3q0zBxh80Bb2QslYY760urLvPVhC7WSZKYo3VAS5AoGBAK3/
gwUZeboNHag7aSUcwbayqp6zg8k+Sh5c1q4Ac40IbD19RKLYMxZETSipbq+iLrXf
VIWxVcL+1rbvL09LZZO5TAC2EY177dQJ1UKlwgMJwBpw+RBtpYnB1AwJMnQsow9t
C7ebPnfediQdLoVv0tUDBTphIkHwjVSnlRFsKWcxAoGAAyP9hKIZM6RRhvaly0wC
LVgqnoEimhNDOGwDyzc5EwB9yQrnReVeGWGtV8vAnYisIRIi8iyWLMBDFMNmIluc
fTFLOMKXUDoL1dj8A/HatuqSPeou7//4FjUxJJqUKpdzm0AyhfmFFAOwXSiO6YqE
KkB5tHCNVUP3R/Eyd7l5/FkCgYEAiyrs3m1L4TWQXPh31skzXy90LE8kvxdlLPfQ
dYfC5DCyclP5S85kvhCPLlCmSTAM8EbaUbxO/hHaJqMUUfXaHtd8JK17SJCw3oGm
4xG1Jbzsu7lUXIF2f8JaGe5ZPnZdTX9IeehfhHyYPbZheTTBisJJsjHyto7yW51W
K4M5cmECgYAYsSsRm30UJeaHMLSyDkh9IMiHpU3DuXPolEVpNo9eS5R+LQ5M0QoE
b9M1I4T1a6Csw+h/EkdG/5R/1ThwMw3dkoalS21c/bnv/kQ5ohnIDfGoZxvdPO75
qAa9CnkNOx7lIsS1ZdbqAWJ4VLwwjqOskNxMf4+4K4boHqybO9vfuw==
-----END RSA PRIVATE KEY----- }}
            HOSTNAME: ${{ip-172-31-83-65}}
            USER_NAME: ${{ubuntu}}
      
        run: |
          echo "$PRIVATE_KEY" > private_key && chmod 600 private_key
          ssh -o StrictHostKeyChecking=no -i private_key ${USER_NAME}@${HOSTNAME} '

              # Now we have got the access of EC2 and we will start the deploy .
              cd /home/ubuntu/<PROJECT_DIRECTORY> &&
              git checkout dev &&
              git fetch --all &&
              git reset --hard origin/dev &&
              git pull origin dev &&
              sudo npm i &&
              sudo npm run build &&
              sudo pm2 stop ./dist/index.js &&
              sudo pm2 start ./dist/index.js
              '
